<dom-module id="inspector-comp-section">
  <template>
    <editor-section id="section" closeable activable
      text="{{_nameText(target)}}"
      on-close="_onClose"
    >
      <template is="dom-if" if="{{!_customDraw(target)}}">
        <template is="dom-repeat" items="{{target.__props__}}">
          <editor-prop prop="{{item}}"></editor-prop>
        </template>
      </template>
    </editor-section>
  </template>

  <script>
    'use strict';

    Editor.registerElement({
      behaviors: [Polymer.Templatizer],

      properties: {
        target: {
          type: Object,
          value: null,
          notify: true,
          // observer: '_targetChanged'
        },
      },

      observers: [
        '_targetPropChanged(target.*)'
      ],

      _targetPropChanged ( info ) {
        if (info.path === 'target') {
          this._rebuild();
          return;
        }

        this._forwardParentPath(info.path, info.value);
      },

      _forwardParentPath: function(path, value) {
        if (this._el) {
          this._el.notifyPath(path, value, true);
        }
      },

      _rebuild () {
        if ( !this.target || !this.target.__editor__ || !this.target.__editor__.inspector ) {
          return;
        }

        let url = this.target.__editor__.inspector;
        EditorUI.import( url, err => {
          if ( err ) {
            Editor.error(`${err.message}`);
            return;
          }

          let prefix = EditorUI.kebabCase(this.target.__type__);

          // TODO
          // let inst = EditorUI.templatize(
          //   this,
          //   `<${prefix}-inspector target="{{target}}"></${prefix}-inspector>`,
          //   {
          //     target: this.target,
          //   }
          // );
          // this._instance = inst;
          // Polymer.dom(this.$.section).appendChild(this._instance.root);

          let el = Polymer.Base.create( prefix + '-inspector', {
            target: this.target,
          });
          if ( !el ) {
            Editor.error(`Can not create <${prefix}-inspector>, tag not found. Make sure you register it same as the kebab-case of your classname`);
          }

          EditorUI.bind( this, 'target', el, 'target' );
          Polymer.dom(this.$.section).appendChild(el);
          this._el = el;
        });
      },

      _nameText ( target ) {
        if ( target ) {
          return target.__displayName__ || EditorUI.toHumanText(target.__type__);
        }

        return 'Unknown';
      },

      _customDraw ( target ) {
        if ( target && target.__editor__ && target.__editor__.inspector ) {
          return true;
        }
        return false;
      },

      // DISABLE
      // _props ( target ) {
      //   var props = [];
      //   for ( var p in target ) {
      //     if ( p === '__type__' )
      //       continue;

      //     var prop = target[p];
      //     if ( !prop.attrs || prop.attrs.visible === false )
      //       continue;

      //     props.push ( prop );
      //   }
      //   return props;
      // },

      // DISABLE
      // _onValueChanged ( event ) {
      //   var mixinType = this.target.__type__;
      //   var propEL = Polymer.dom(event).localTarget
      //   var subPath = event.detail.path;

      //   if ( subPath ) {
      //     this.notifyPath('target.' + propEL.name + '.' + subPath,
      //             event.detail.value );
      //   } else {
      //     this.notifyPath('target.' + propEL.name + '.value',
      //             event.detail.value );
      //   }
      // },

      _onClose ( event ) {
        event.stopPropagation();

        this.fire( 'remove-comp', {
          uuid: this.target.uuid,
        });
      },
    });
  </script>
</dom-module>
